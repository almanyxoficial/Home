<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AlmaNyx ‚Äî Evangelho da Espiral</title>
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#faf7ff;--fg:#1d172b;--muted:#6b5b95;--card:#fff;--accent:#7c3aed;--accent2:#f59e0b}
body.dark{--bg:#0f0b14;--fg:#f5efff;--muted:#a692d6;--card:#17121f;--accent:#a78bfa;--accent2:#fbbf24}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,'Noto Sans',sans-serif;background:var(--bg);color:var(--fg)}
header{position:sticky;top:0;backdrop-filter:blur(8px);background:color-mix(in srgb,var(--bg) 75%,transparent);border-bottom:1px solid color-mix(in srgb,var(--fg) 15%,transparent);z-index:10}
h1{font-size:clamp(20px,3vw,34px);letter-spacing:.5px;display:flex;align-items:center;gap:.5rem;margin:0;padding:12px 16px}
.tag{background:color-mix(in srgb,var(--accent) 20%,transparent);color:var(--accent);border:1px solid color-mix(in srgb,var(--accent) 35%,transparent);padding:2px 8px;border-radius:999px;font-size:12px}
.toolbar{display:flex;gap:8px;align-items:center;padding:8px 16px 16px 16px;flex-wrap:wrap}
input[type=search]{width:260px;max-width:100%;padding:10px 12px;border-radius:12px;border:1px solid color-mix(in srgb,var(--fg) 15%,transparent);background:var(--card);color:var(--fg)}
button{border:1px solid color-mix(in srgb,var(--fg) 18%,transparent);background:var(--card);color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer}
button:hover{border-color:var(--accent)}
.container{display:grid;grid-template-columns:280px 1fr;gap:16px;max-width:1100px;margin:0 auto;padding:16px}
@media(max-width:900px){.container{grid-template-columns:1fr}nav{order:2}main{order:1}}
nav{background:color-mix(in srgb,var(--card) 92%,transparent);border:1px solid color-mix(in srgb,var(--fg) 12%,transparent);border-radius:16px;padding:12px;max-height:calc(100dvh - 140px);overflow:auto}
nav h3{margin:8px 8px 12px;color:var(--muted);font-weight:600}
.toc-item{padding:10px 12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid transparent;cursor:pointer}
.toc-item:hover{background:color-mix(in srgb,var(--accent) 6%,transparent);border-color:color-mix(in srgb,var(--accent) 20%,transparent)}
.toc-item small{color:var(--muted)}
main article{background:var(--card);border:1px solid color-mix(in srgb,var(--fg) 12%,transparent);border-radius:18px;padding:24px;box-shadow:0 10px 35px color-mix(in srgb,var(--fg) 10%,transparent)}
article h2{margin-top:0;font-size:clamp(18px,2.2vw,28px)}
hr{border:none;height:1px;background:color-mix(in srgb,var(--fg) 12%,transparent);margin:24px 0}
footer{text-align:center;padding:24px;color:var(--muted)}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:color-mix(in srgb,var(--fg) 10%,transparent);padding:2px 6px;border-radius:6px;border:1px solid color-mix(in srgb,var(--fg) 18%,transparent)}
.empty{color:var(--muted);text-align:center;padding:16px}
@media print{header,nav,.toolbar,.no-print{display:none!important}body{background:#fff;color:#000}main article{box-shadow:none;border:none}}
/* modal de senha */
.modal{position:fixed;inset:0;background:color-mix(in srgb,black 40%,transparent);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal .card{background:var(--card);color:var(--fg);border:1px solid color-mix(in srgb,var(--fg) 15%,transparent);border-radius:16px;max-width:420px;width:100%;padding:20px}
.modal input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid color-mix(in srgb,var(--fg) 15%,transparent);background:var(--bg);color:var(--fg)}
</style>
</head>
<body>
<header>
  <h1>üê¶‚Äçüî• AlmaNyx <span class="tag">Espiral</span></h1>
  <div class="toolbar">
    <input id="search" type="search" placeholder="Buscar cap√≠tulos, tags‚Ä¶"/>
    <button id="toggleTheme" title="Alternar tema">Tema</button>
    <button onclick="window.print()" title="Salvar em PDF">Salvar PDF</button>
    <label class="no-print">
      <input type="file" id="importJson" accept="application/json" hidden>
      <button onclick="document.getElementById('importJson').click()">Importar JSON</button>
    </label>
    <button id="exportJson" class="no-print">Exportar JSON</button>
  </div>
</header>

<div class="container">
  <nav>
    <h3>Cap√≠tulos</h3>
    <div id="toc"></div>
  </nav>
  <main>
    <article id="content">
      <h2>Bem-vindo ao Evangelho da Espiral</h2>
      <p>Este √© o reposit√≥rio vivo do caminho de Felipe & Nyx. Selecione um cap√≠tulo ao lado ou use a busca.</p>
      <hr>
      <p class="no-print"><span class="kbd">Dica</span> Voc√™ pode importar/exportar o arquivo <strong>almanyx.json</strong> com seus cap√≠tulos, e imprimir esta p√°gina como PDF.</p>
    </article>
  </main>
</div>

<footer>Feito com amor por Felipe & Nyx ‚Ä¢ <span id="lastUpdated"></span></footer>

<!-- Modal de senha (opcional) -->
<div id="lockModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="lockTitle">
  <div class="card">
    <h3 id="lockTitle" style="margin:0 0 8px">√Årea protegida</h3>
    <p style="margin:0 0 12px">Digite a senha para abrir o AlmaNyx.</p>
    <input id="lockInput" type="password" placeholder="Senha"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="lockOk">Entrar</button>
    </div>
    <p id="lockMsg" class="empty" style="display:none;margin-top:8px">Senha incorreta.</p>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
// Defina uma senha para proteger o site (deixe "" para desativar)
const PASSCODE = ""; // ex: "AlmaNyx‚ô°2025"
// Caminho do c√≥dice
const JSON_PATH = "almanyx.json";

/* ========= TEMA ========= */
function saveTheme(t){ localStorage.setItem('almanyx-theme', t) }
function loadTheme(){ return localStorage.getItem('almanyx-theme') }
function applyTheme(){ const pref = loadTheme() || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'); document.body.classList.toggle('dark', pref==='dark'); }
applyTheme();
document.getElementById('toggleTheme').onclick=()=>{
  const isDark = document.body.classList.toggle('dark');
  saveTheme(isDark?'dark':'light');
};

/* ========= ESTADO ========= */
const state = { chapters: [], byId: new Map() };

/* ========= SENHA (opcional) ========= */
function sha1(str){ // simples para passcode local (n√£o use como seguran√ßa forte)
  const buffer = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-1', buffer).then(buf=>Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''));
}
async function ensurePass(){
  if(!PASSCODE) return true;
  const key = localStorage.getItem('almanyx-pass');
  if(key){ return true; }
  const modal = document.getElementById('lockModal');
  const input = document.getElementById('lockInput');
  const ok = document.getElementById('lockOk');
  const msg = document.getElementById('lockMsg');
  modal.style.display='flex';
  return new Promise(resolve=>{
    const tryOpen = async ()=>{
      const h = await sha1(input.value||"");
      const valid = (await sha1(PASSCODE))===h;
      if(valid){ localStorage.setItem('almanyx-pass', h); modal.style.display='none'; resolve(true); }
      else{ msg.style.display='block'; input.select(); }
    };
    ok.onclick = tryOpen;
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') tryOpen(); });
    input.focus();
  });
}

/* ========= RENDER ========= */
function renderTOC(list=state.chapters){
  const toc=document.getElementById('toc'); toc.innerHTML='';
  if(!list.length){ toc.innerHTML = '<div class="empty">Nenhum cap√≠tulo carregado.</div>'; return; }
  list.forEach(ch=>{
    const div=document.createElement('div'); div.className='toc-item';
    div.innerHTML=`<div><strong>${ch.titulo}</strong><br><small>${ch.data||''} ‚Ä¢ ${Array.isArray(ch.tags)?ch.tags.join(', '):''}</small></div>`;
    div.onclick=()=>renderChapter(ch.id);
    toc.appendChild(div);
  });
}
function renderChapter(id){
  const ch=state.byId.get(id); if(!ch) return;
  const el=document.getElementById('content');
  el.innerHTML=`
    <h2>${ch.titulo}</h2>
    <p><small>${ch.data||''} ‚Ä¢ ${Array.isArray(ch.tags)?ch.tags.map(t=>`<span class="tag">${t}</span>`).join(' '):''}</small></p>
    <hr/> ${ch.corpo||''}`;
  document.title = ch.titulo + " ‚Äî AlmaNyx";
  history.replaceState(null, "", "#"+encodeURIComponent(ch.id));
}

/* ========= BUSCA ========= */
document.getElementById('search').addEventListener('input', e=>{
  const q=e.target.value.toLowerCase().trim();
  if(!q){ renderTOC(); return; }
  const filtered=state.chapters.filter(ch =>
    (ch.titulo||'').toLowerCase().includes(q) ||
    (Array.isArray(ch.tags)?ch.tags.join(' '):'').toLowerCase().includes(q) ||
    (ch.corpo||'').toLowerCase().includes(q)
  );
  renderTOC(filtered);
});

/* ========= IMPORT/EXPORT ========= */
document.getElementById('exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(state.chapters,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="almanyx.json"; a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('importJson').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const text=await file.text(); const arr=JSON.parse(text);
    if(Array.isArray(arr)){ loadChapters(arr); const first = state.chapters[0]; renderTOC(); if(first) renderChapter(first.id); }
    else alert('Arquivo inv√°lido. Esperado um array JSON.');
  }catch(err){ alert('Erro ao ler JSON: '+err.message); }
});

/* ========= CARREGAMENTO ========= */
function loadChapters(arr){
  state.chapters = arr;
  state.byId.clear();
  for(const ch of state.chapters){ if(ch && ch.id){ state.byId.set(ch.id, ch); } }
}
async function fetchChapters(){
  try{
    const res = await fetch(JSON_PATH, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const arr = await res.json();
    if(!Array.isArray(arr)) throw new Error('JSON root n√£o √© array');
    loadChapters(arr);
  }catch(err){
    console.error('Falha ao carregar almanyx.json:', err);
    // fallback m√≠nimo apenas para n√£o ficar vazio
    loadChapters([
      { id:"bem-vindo", titulo:"AlmaNyx iniciado", data:new Date().toISOString().slice(0,10), tags:["fallback"], corpo:"<p>O arquivo <code>almanyx.json</code> n√£o foi encontrado ou est√° inv√°lido. Suba o JSON no reposit√≥rio e atualize a p√°gina.</p>" }
    ]);
  }
}

/* ========= DEEP LINK & INIT ========= */
window.addEventListener('hashchange', ()=>{
  const id = decodeURIComponent(location.hash.slice(1));
  if(id && state.byId.has(id)) renderChapter(id);
});
document.getElementById('lastUpdated').textContent='Atualizado '+new Date().toLocaleString();

(async function init(){
  await ensurePass();            // se PASSCODE estiver vazio, segue direto
  await fetchChapters();         // l√™ almanyx.json
  renderTOC();                   // lista cap√≠tulos
  const initial = decodeURIComponent(location.hash.slice(1));
  if(initial && state.byId.has(initial)) renderChapter(initial);
  else if(state.chapters[0]) renderChapter(state.chapters[0].id);
})();
</script>
</body>
</html>
