<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AlmaNyx — Público</title>
<meta name="description" content="AlmaNyx — reflexões em espiral, diários de ascensão, geometria viva.">
<link rel="icon" href="./public/favicon.png">
<style>
  :root{
    --bg:#ffffff; --fg:#111; --muted:#6b6b6b; --line:#e9e9e9; --max:900px;
    --brand:#0f172a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:400 16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:var(--max);margin:0 auto;padding:28px 22px}
  header .brand{display:flex;gap:12px;align-items:center;justify-content:center}
  header .brand img{width:28px;height:28px}
  header h1{margin:6px 0 0;font:800 34px/1.2 ui-serif, Georgia, "Times New Roman", serif; letter-spacing:.2px}
  header p.sub{margin:8px 0 0;color:var(--muted);text-align:center}
  .bar{margin:18px auto 10px; max-width:760px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  input[type="search"]{flex:1 1 360px; padding:12px 14px; border:1px solid var(--line); border-radius:10px; outline:none}
  .tags{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  .tag{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#f7f7f8; color:#333; cursor:pointer}
  .tag.on{background:var(--brand); color:#fff; border-color:var(--brand)}
  hr.sep{border:0;border-top:1px solid var(--line);margin:22px 0 10px}
  article{padding:20px 0;border-bottom:1px dashed var(--line)}
  article:last-child{border-bottom:none}
  article h2{margin:0 0 6px;font:700 24px/1.25 ui-serif, Georgia, serif}
  article small{display:block;color:var(--muted);margin-bottom:10px}
  nav#toc{margin-top:18px}
  nav#toc a{display:inline-block;margin:4px 10px 0 0;color:#444;text-decoration:none;border-bottom:1px dotted #bbb}
  .center{display:flex;align-items:center;justify-content:center;padding:18px 0}
  .error{color:#b00020;background:#fff5f6;border:1px solid #ffd6db;padding:10px 12px;border-radius:8px}
  footer{color:var(--muted);border-top:1px solid var(--line);margin-top:20px}
  footer .grid{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  footer a{color:#555;text-decoration:none;border-bottom:1px dotted #aaa}
  @media (prefers-color-scheme:dark){
    :root{--bg:#0b0c0e;--fg:#e9e9e9;--muted:#a9a9a9;--line:#1b1c20;--brand:#cbd5e1}
    .tag{background:#121419;color:#ddd;border-color:#20232a}
    .tag.on{background:#e5e7eb;color:#000;border-color:#e5e7eb}
  }
</style>
</head>
<body>
  <header class="wrap">
    <div class="brand"><img src="./public/logo.svg" alt="AlmaNyx logo"><h1>AlmaNyx</h1></div>
    <p class="sub">Reflexões públicas — espiral, verdade, prática.</p>
    <div class="bar">
      <input id="q" type="search" placeholder="Pesquisar por título, texto ou tag…" autocomplete="off">
    </div>
    <div id="tags" class="tags"></div>
    <hr class="sep">
  </header>

  <main class="wrap" id="main">
    <div id="status" class="center">Carregando conteúdos…</div>
    <section id="posts" class="hidden"></section>
    <nav id="toc" aria-label="Índice"></nav>
  </main>

  <footer class="wrap">
    <div class="grid">
      <small>© <span id="year"></span> AlmaNyx — público</small>
      <small><a href="#" id="rss">RSS</a></small>
    </div>
  </footer>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const postsEl = $('#posts');
  const tagsEl  = $('#tags');
  const tocEl   = $('#toc');
  const status  = $('#status');
  const qInput  = $('#q');
  let DATA = { posts: [] };
  let activeTag = null;

  const htmlToText = (h)=>{const e=document.createElement('div');e.innerHTML=h||'';return e.textContent||''};

  function renderTags(){
    const set = new Set();
    DATA.posts.forEach(p => (p.tags||[]).forEach(t => set.add(t)));
    tagsEl.innerHTML = '';
    if(!set.size) return;
    const mk = (label,val)=> {
      const s = document.createElement('span');
      s.className = 'tag' + (activeTag===val ? ' on':'');
      s.textContent = label;
      s.onclick = () => { activeTag = val; filter(); };
      return s;
    };
    tagsEl.appendChild(mk('Todos', null));
    [...set].sort().forEach(t => tagsEl.appendChild(mk(t, t)));
  }

  function filter(){
    const q = (qInput.value||'').toLowerCase().trim();
    const list = DATA.posts.filter(p=>{
      if(activeTag && !(p.tags||[]).includes(activeTag)) return false;
      if(!q) return true;
      const hay = (p.titulo+' '+(p.tags||[]).join(' ')+' '+htmlToText(p.corpo)).toLowerCase();
      return hay.includes(q);
    });
    renderPosts(list);
  }

  function renderPosts(list){
    if(!list.length){
      postsEl.innerHTML = '<p class="error">Nenhum conteúdo encontrado.</p>';
      status.classList.add('hidden');
      return;
    }
    postsEl.innerHTML = list.map(p=>`
      <article id="${p.id}">
        <h2>${p.titulo}</h2>
        <small>${p.data||''}${(p.tags&&p.tags.length)?' — '+p.tags.join(', '):''}</small>
        ${p.corpo||''}
      </article>
    `).join('');
    tocEl.innerHTML = list.map(p=>`<a href="#${p.id}">${p.titulo}</a>`).join('');
    status.classList.add('hidden');
  }

  async function load(){
    try{
      const res = await fetch('./public/public_posts.json?v='+Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error(res.status);
      const j = await res.json();
      DATA.posts = (j.posts||[]).slice().sort((a,b)=> String(b.data||'').localeCompare(String(a.data||'')));
      renderTags(); filter();
      if(location.hash){
        const el = document.getElementById(location.hash.slice(1));
        if(el) setTimeout(()=>el.scrollIntoView({behavior:'smooth'}), 120);
      }
    }catch(e){
      status.innerHTML = '<div class="error">Erro ao carregar conteúdos.</div>';
      console.error(e);
    }
  }

  qInput.addEventListener('input', filter);
  window.addEventListener('hashchange', ()=>{
    const el = document.getElementById(location.hash.slice(1));
    if(el) el.scrollIntoView({behavior:'smooth'});
  });
  document.addEventListener('DOMContentLoaded',()=>{
    $('#year').textContent = new Date().getFullYear();
    load();
  });
})();
</script>
</body>
</html>
